<html>
    <head>
        <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
        <script type="text/javascript">
        var video_queue = localStorage["video_queue"];
        
        chrome.browserAction.onClicked.addListener(function(tab) {
            visit_url("about: blank");
            setTimer(1);
        });
        
        chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
            if (tabId == window.tabId) {
                window.tabId = null;
                if(window.timer) clearTimeout(window.timer);
            }
        });
        
        function watch_video() 
        {
            //No point to working if no window.
            if (window.tabId == null) return;

            var myVideo = get_local_video();
            
            if (Object.size(myVideo) > 0)
            {
                visit_url(myVideo.video_url);
                setTimer(myVideo.timer);
            }
            else 
            {
                get_video_list();
                setTimer(30);
            }
        }
        
        function setTimer(time) 
        {
            var miliseconds = time * 1000;
            if(window.timer) clearTimeout(window.timer);
            window.timer = setTimeout("watch_video()", miliseconds);
        }
        
        function clearTimer() 
        {
            if(window.timer) clearTimeout(window.timer);
        }
        
        function s4wLogin() 
        {
            $.ajax({
                url: 'http://subwho.com/login',
                type: "POST",
                dataType: "JSON",
                data: {
                    mobile: 1,
                    username: localStorage["username"],
                    password: localStorage["password"]
                },
                async: false,
                success: function(response) {
                    if (response.success == 0) {
                        alert('Failed to Login');
                    }
                }
            })
        }
        
        function get_video_list() 
        {
            var video_queue = new Array();
            
            $.ajax({
                url: 'http://subwho.com/auto/get_videos',
                dataType: 'json',
                async: false,
                success: function(response) {
                    if (response.is_logged_in) 
                    {
                        if (response.videos) video_queue = response.videos;
                    } 
                    else 
                    {
                        s4wLogin();
                    }
                }
            })
            localStorage["video_queue"] = JSON.stringify(video_queue);
        }
        
        function get_local_video() 
        {
            var queue = JSON.parse(localStorage["video_queue"]);
            
            if (queue.length > 0) 
            {
                video = queue.shift();
                localStorage["video_queue"] = JSON.stringify(queue);
                
                return video;
            } 
            else
            {
                return false;
            }
        }
        
        function visit_url(url)
        {
            if(window.tabId == null) 
            { 
                chrome.tabs.create({url: url, selected: true}, function(tab) {
                    window.tabId = tab.id
                });
            } 
            else 
            {
                chrome.tabs.update(window.tabId, {url: url, selected: true});
            }
        }
        
        Object.size = function(obj) 
        {
            var size = 0, key;
            for (key in obj) {
                if (obj.hasOwnProperty(key)) size++;
            }
            return size;
        };
        </script>
    </head>
</html>
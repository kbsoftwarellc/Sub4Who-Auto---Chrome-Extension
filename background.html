<html>
    <head>
        <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
        <script type="text/javascript">
        window.last_url = null;
                
        chrome.browserAction.onClicked.addListener(function(tab) {
            if (window.tabId > 0) return;
            
            var username = Object.load("username");
            var password = Object.load("password"); 
            var user_key = Object.load("user_key");
            
            if (username == undefined || username.length == 0 || password == undefined || password.length == 0)
            {
                alert('Please configure your login before using the plugin');
                return;
            }
            
            if (user_key == undefined || user_key.length == 0)
            {
                user_key = get_user_key();
                if (user_key.length > 0) Object.save("user_key", user_key);
            }
            
            visit_url("about: blank");
            setTimer(1);
        });
        
        chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
            if (tabId == window.tabId) 
            {
                window.tabId = null;
                if(window.timer) clearTimeout(window.timer);
            }
        });
        
        function watch_video() 
        {
            //No point to working if no window.
            if (window.tabId == null) return;

            var myVideo = get_local_video();
            
            if (Object.size(myVideo) > 0)
            {
                visit_url(myVideo.video_url);
                setTimer(myVideo.timer);
            }
            else 
            {
                get_video_list();
                setTimer(30);
            }
        }
        
        function setTimer(seconds) 
        {
            var miliseconds = seconds * 1000;
            if(window.timer) clearTimeout(window.timer);
            window.timer = setTimeout("watch_video()", miliseconds);
        }
        
        function clearTimer() 
        {
            if(window.timer) clearTimeout(window.timer);
        }
        
        function get_video_list() 
        {
            var video_queue = new Array();
            
            $.ajax({
                url: 'http://subwho.com/auto/get_videos',
                dataType: 'json',
                data: {user_key: Object.load("user_key")},
                async: false,
                success: function(response) {
                    if (response.is_logged_in) 
                    {
                        if (response.videos) video_queue = response.videos;
                    }
                }
            })
            
            localStorage["video_queue"] = JSON.stringify(video_queue);
        }
        
        function get_local_video() 
        {
            var queue = JSON.parse(localStorage["video_queue"]);
            
            if (queue.length > 0) 
            {
                video = queue.shift();
                localStorage["video_queue"] = JSON.stringify(queue);
                
                return video;
            } 
            else
            {
                return false;
            }
        }
        
        function visit_url(url)
        {
            if(window.tabId == null) 
            {                
                chrome.tabs.create({url: url, selected: true}, function(tab) {
                    window.tabId = tab.id
                });
            } 
            else 
            {
                chrome.tabs.get(window.tabId, function(tabInfo) {
                   if (tabInfo.url == window.last_url) return_video_info();
                   window.last_url = url;
                });
                
                chrome.tabs.update(window.tabId, {url: url, selected: true}, function(tabInfo) {
                    window.last_url = url;
                });
            }
        }
        
        function return_video_info() 
        {
            return; //temporary until I finish return_video page
            $.ajax({
                url: 'http://subwho.com/auto/return_video',
                dataType: 'json',
                async: false,
                success: function(response) {
                    if (response.is_logged_in) 
                    {
                        if (response.videos) video_queue = response.videos;
                    }
                }
            })
        }
        
        function get_user_key()
        {
            var user_key = '';
            
            $.ajax({
                url: 'http://subwho.com/remote/user_data',
                dataType: 'json',
                data: {
                    username: Object.load("username"),
                    password: Object.load("password")
                },
                async: false,
                success: function(response) {
                    if (response.user_key) user_key = response.user_key;
                }
            })
            
            return user_key;
        }
        
        Object.size = function(obj) 
        {
            var size = 0, key;
            for (key in obj) {
                if (obj.hasOwnProperty(key)) size++;
            }
            return size;
        };
        
        Object.store = function(key, value)
        {
            localStorage[key] = value;
            return true;
        };
        
        Object.load = function(key)
        {
            return localStorage[key];
        };
        </script>
    </head>
</html>